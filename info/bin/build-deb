#!/usr/bin/env bash
set -o verbose

if [ ! -d info ];then
    echo "You are not inside an Application or Application-wrapper directory"
    exit 1
fi

BUILD_NUMBER=`cat info/BUILD_VERSION`
PACKAGE_NAME=`cat info/NAME`
PACKAGE_DESC=`cat info/DESCRIPTION`
PACKAGE_URL=`cat info/URL`
PACKAGE_VERS=`cat info/VERSION`
PACKAGE_DEPENDS=`cat info/DEPENDS`

# Download GEMS into src directory
gem install \
   --no-ri \
   --no-rdoc \
   --install-dir src/opt/oss/fpm/${PACKAGE_VERS}/ \
   fpm

# Use fpm to package fpm ~~> mind-blown.
SRC_DIRS=$(ls -m src/|sed 's/,/ /g')

export GEM_HOME=$PWD/src/opt/oss/fpm/$PACKAGE_VERS

$PWD/src/opt/oss/fpm/${PACKAGE_VERS}/bin/fpm -n ${PACKAGE_NAME} \
   -v $PACKAGE_VERS \
   -s dir \
   -C src \
   -t deb \
   --verbose \
   --url "$PACKAGE_URL" \
   --description "$PACKAGE_DESC" \
   --iteration "baseblack-r$BUILD_NUMBER" \
   --replaces "$PACKAGE_NAME (<< $PACKAGE_VERS)" ${SRC_DIRS}


echo `expr ${PACKAGE_BUILD_VERSION} + 1` > info/BUILD_VERSION

exit ${PIPESTATUS[0]}
